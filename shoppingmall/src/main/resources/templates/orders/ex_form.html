<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="fragment/common :: head('주문 폼')">

</head>

<body>

    <!-- Topbar Start -->
    <div th:replace="fragment/common :: topbar"></div>
    <!-- Topbar End -->


    <!-- Navbar Start -->
    <div class="container-fluid">
        <div class="row border-top px-xl-5">
            <div class="col-lg-3 d-none d-lg-block">
                <a class="btn shadow-none d-flex align-items-center justify-content-between bg-primary text-white w-100" data-toggle="collapse" href="#navbar-vertical" style="height: 65px; margin-top: -1px; padding: 0 30px;">
                    <h6 class="m-0">카테고리</h6>
                    <i class="fa fa-angle-down text-dark"></i>
                </a>
                <nav class="collapse position-absolute navbar navbar-vertical navbar-light align-items-start p-0 border border-top-0 border-bottom-0 bg-light" id="navbar-vertical" style="width: calc(100% - 30px); z-index: 1;">
                    <div th:replace="fragment/common :: category"></div>
                </nav>
            </div>
            <div class="col-lg-9">
                <div th:replace="fragment/common :: navbar"></div>
            </div>
        </div>
    </div>
    <!-- Navbar End -->


    <form class="product-register" th:id="purchase" th:action="@{/orders/purchase}" method="post">
        <h2>주문/결제</h2>

        <input type="hidden" th:id="num" th:name="num" th:value="${num}">
        <input type="hidden" th:name="goods" th:value="${ordersDto.goods.id}">

        <h4>주문자 정보</h4>
        <div class="mb-3 row">
            <div class="col-sm-2 col-form-label">이름</div>
            <div class="col-sm-2">
                <input type="text" class="form-control" th:id="ordererName" th:name="ordererName" th:value="${user.name}">
            </div>
        </div>
        <div class="mb-3 row">
            <div class="col-sm-2 col-form-label">이메일</div>
            <div class="input-group mb-3 col">
                <input type="text" class="form-control" th:id="ordererEmailId" th:name="ordererEmailId" th:value="${user.emailId}">
                <span class="input-group-text">@</span>
                <input type="text" class="form-control" th:id="ordererEmailAddress" th:name="ordererEmailAddress" th:value="${user.emailAddress}">
            </div>
        </div>
        <div class="mb-3 row">
            <div class="col-sm-2 col-form-label">연락처</div>
            <div class="col-sm-1">
                <input type="text" class="form-control" th:id="ordererPhone1" th:name="ordererPhone1" th:value="${user.phone1}">
            </div>
            <div class="col-sm-1">
                <input type="text" class="form-control" th:id="ordererPhone2" th:name="ordererPhone2" th:value="${user.phone2}">
            </div>
            <div class="col-sm-1">
                <input type="text" class="form-control" th:id="ordererPhone3" th:name="ordererPhone3" th:value="${user.phone3}">
            </div>
        </div>

        <h4>배송지 정보</h4>
        <div class="mb-3 row">
            <div class="col-sm-2 col-form-label">이름</div>
            <div class="col-sm-2">
                <input type="text" class="form-control" th:name="deliveryName" th:value="${user.name}">
            </div>
        </div>
        <div class="mb-3 row">
            <div class="col-sm-2 col-form-label">우편번호</div>
            <div class="col-sm-2">
                <input type="text" class="form-control" th:id="deliveryPostalCode" th:name="deliveryPostalCode" th:value="${user.postalCode}">
            </div>
        </div>
        <div class="mb-3 row">
            <div class="col-sm-2 col-form-label">주소</div>
            <div class="col-sm-3">
                <input type="text" class="form-control" th:id="deliveryAddress" th:name="deliveryAddress" th:value="${user.address}">
            </div>
            <div class="col-sm-3">
                <input type="text" class="form-control" th:id="deliveryExtraAddress" th:name="deliveryExtraAddress" th:value="${user.extraAddress}">
            </div>
            <div class="col-sm-3">
                <input type="text" class="form-control" th:id="deliveryDetailAddress" th:name="deliveryDetailAddress" th:value="${user.detailAddress}">
            </div>
        </div>
        <div class="mb-3 row">
            <div class="col-sm-2 col-form-label">연락처</div>
            <div class="col-sm-1">
                <input type="text" class="form-control" th:name="deliveryPhone1" th:value="${user.phone1}">
            </div>
            <div class="col-sm-1">
                <input type="text" class="form-control" th:name="deliveryPhone2" th:value="${user.phone2}">
            </div>
            <div class="col-sm-1">
                <input type="text" class="form-control" th:name="deliveryPhone3" th:value="${user.phone3}">
            </div>
        </div>
        <div class="mb-3 row">
            <div class="col-sm-2 col-form-label">배송 요청사항</div>
            <div class="col-sm-5">
                <input type="text" class="form-control" th:name="deliveryRequest">
            </div>
        </div>

        <h4>상품 정보</h4>
        <div class="mb-3 row">
            <div class="col-sm-2 col-form-label">이미지</div>
            <div class="col-sm-5">
                <input type="text" class="form-control" readonly>
            </div>
        </div>
        <div class="mb-3 row">
            <div class="col-sm-2 col-form-label">상품명</div>
            <div class="col-sm-5">
                <input type="text" class="form-control" th:id="productName" th:value="${ordersDto.goods.product.name}" readonly>
            </div>
        </div>
        <div class="mb-3 row">
            <div class="col-sm-2 col-form-label">옵션</div>
            <div class="col-sm-5">
                <input type="text" class="form-control" th:value="${'(색상) ' + ordersDto.goods.productColor.color + ' (사이즈) ' + ordersDto.goods.productSize.size}" readonly>
            </div>
        </div>
        <div class="mb-3 row">
            <div class="col-sm-2 col-form-label">수량</div>
            <div class="col-sm-5">
                <input type="text" class="form-control" readonly>
            </div>
        </div>
        <div class="mb-3 row">
            <div class="col-sm-2 col-form-label">가격</div>
            <div class="col-sm-5">
                <input type="text" class="form-control" th:id="productPrice" th:value="${ordersDto.goods.product.price}" readonly>
            </div>
        </div>
        <div class="mb-3 row">
            <div class="col-sm-2 col-form-label">할인</div>
            <div class="col-sm-10">
                <input type="text" class="form-control" readonly>
            </div>
        </div>
        <div class="mb-3 row">
            <div class="col-sm-2 col-form-label">배송비</div>
            <div class="col-sm-10">
                <input type="text" class="form-control" readonly>
            </div>
        </div>
        <div class="mb-3 row">
            <div class="col-sm-2 col-form-label">총주문금액</div>
            <div class="col-sm-10">
                <input type="text" class="form-control" readonly>
            </div>
        </div>

        <h4>결제 수단</h4>
        <div class="mb-3 row">
            <div class="col-sm-2 col-form-label">빈공간</div>
            <div class="col-sm-10">
                <input type="text" class="form-control" readonly>
            </div>
        </div>

        <table class="table table-striped">
            <thead>
            <tr>
                <th scope="col">이미지</th>
                <th scope="col">상품정보</th>
                <th scope="col">판매가</th>
                <th scope="col">수량</th>
                <th scope="col">적립금</th>
                <th scope="col">배송구분</th>
                <th scope="col">배송비</th>
                <th scope="col">합계</th>
            </tr>
            </thead>
            <tbody>
            <!--            <tr th:each="board : ${boards}">
                            <td th:text="${board.board_num}">글번호</td>
                            <td><a th:text="${board.title}"
                                   th:href="@{/board/view(board_num=${board.board_num})}">제목</a></td>
                            <td th:text="${board.user.username}">닉네임</td>-->
            <!--                <td th:text="${}">등록일</td>
                            <td th:text="${}">조회</td>
                            <td th:text="${}">추천</td>-->
            </tr>
            </tbody>
        </table>
        <!--onclick은 뭐고 submit은 뭐지 == 버튼타입때매 이니시스 결제창이 안뜬거였음 ㅡㅡ -->
        <button th:onclick="requestPay(this.form)" class="w-100 btn btn-primary btn-lg" type="button">결제하기</button>
    </form>


    <!-- Footer Start -->
    <div th:replace="fragment/common :: footer"></div>
    <!-- Footer End -->


    <!-- JavaScript -->
    <div th:replace="fragment/common :: js"></div>


    <!-- iamport.payment.js -->
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.1.8.js"></script>


    <script>
        function requestPay() {
            IMP.init('imp89950763'); // 가맹점 식별코드
            IMP.request_pay({
                pg : 'html5_inicis',
                pay_method : 'card',
                merchant_uid: document.getElementById("num").value, // 상점에서 관리하는 주문 번호
                name : document.getElementById("productName").value,
                amount : document.getElementById("productPrice").value,
                buyer_name : document.getElementById("ordererName").value,
                buyer_email : document.getElementById("ordererEmailId").value + '@' + document.getElementById("ordererEmailAddress").value,
                buyer_tel : document.getElementById("ordererPhone1").value + '-' + document.getElementById("ordererPhone2").value + '-' + document.getElementById("ordererPhone3").value,
                buyer_postcode : document.getElementById("deliveryPostalCode").value,
                buyer_addr : document.getElementById("deliveryAddress").value + ' ' + document.getElementById("deliveryExtraAddress").value + ' ' + document.getElementById("deliveryDetailAddress").value
            }, function(rsp) {
                if ( rsp.success ) {
                    //[1] 서버단에서 결제정보 조회를 위해 jQuery ajax로 imp_uid 전달하기
                    $.ajax({
                        url: "/orders/purchase", //cross-domain error가 발생하지 않도록 주의해주세요
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            imp_uid : rsp.imp_uid
                            //기타 필요한 데이터가 있으면 추가 전달
                        }
                    }).done(function(data) {
                        //[2] 서버에서 REST API로 결제정보확인 및 서비스루틴이 정상적인 경우
                        if ( everythings_fine ) {
                            var msg = '결제가 완료되었습니다.';
                            msg += '\n고유ID : ' + rsp.imp_uid;
                            msg += '\n상점 거래ID : ' + rsp.merchant_uid;
                            msg += '\n결제 금액 : ' + rsp.paid_amount;
                            msg += '카드 승인번호 : ' + rsp.apply_num;

                            alert(msg);
                        } else {
                            //[3] 아직 제대로 결제가 되지 않았습니다.
                            //[4] 결제된 금액이 요청한 금액과 달라 결제를 자동취소처리하였습니다.
                        }
                    });
                    location.href='list';
                    document.getElementById("purchase").submit();
                } else {
                    var msg = '결제에 실패하였습니다.';
                    msg += '\n에러내용 : ' + rsp.error_msg;

                    alert(msg);
                }
            });
        }
    </script>

</body>

</html>